# ==============================================================================
# GitHub Actions Workflow - Despliegue Autom√°tico a Producci√≥n
# ==============================================================================
# 
# Estructura personalizada:
# - Backend: /var/www/TestMillion/Back (proyecto .NET directo)
# - Frontend: /var/www/TestMillion/Front (proyecto Next.js directo)
# 
# Este workflow NO requiere que los directorios sean repositorios git
# ==============================================================================

name: üöÄ Deploy to Production

on:
  push:
    branches:
      - main

env:
  NODE_VERSION: '18.x'
  DOTNET_VERSION: '9.0.x'

jobs:
  # ==============================================================================
  # JOB 0: Validar Secretos
  # ==============================================================================
  validate-secrets:
    name: üîç Validate Secrets
    runs-on: ubuntu-latest
    environment: PRODUCTION
    
    steps:
      - name: üîç Check Required Secrets
        run: |
          echo "=================================================="
          echo "üîç Validando secretos de GitHub..."
          echo "=================================================="
          
          ERROR=0
          
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "‚ùå ERROR: SSH_HOST no est√° configurado"
            ERROR=1
          else
            echo "‚úÖ SSH_HOST: configurado"
          fi
          
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "‚ùå ERROR: SSH_USER no est√° configurado"
            ERROR=1
          else
            echo "‚úÖ SSH_USER: configurado"
          fi
          
          if [ -z "${{ secrets.SSH_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_KEY no est√° configurado"
            ERROR=1
          else
            echo "‚úÖ SSH_KEY: configurado"
          fi
          
          if [ -z "${{ secrets.APP_PATH_BACKEND }}" ]; then
            echo "‚ùå ERROR: APP_PATH_BACKEND no est√° configurado"
            ERROR=1
          else
            echo "‚úÖ APP_PATH_BACKEND: ${{ secrets.APP_PATH_BACKEND }}"
          fi
          
          if [ -z "${{ secrets.APP_PATH_FRONTEND }}" ]; then
            echo "‚ùå ERROR: APP_PATH_FRONTEND no est√° configurado"
            ERROR=1
          else
            echo "‚úÖ APP_PATH_FRONTEND: ${{ secrets.APP_PATH_FRONTEND }}"
          fi
          
          if [ -z "${{ secrets.PM2_APP_NAME_FRONTEND }}" ]; then
            echo "‚ùå ERROR: PM2_APP_NAME_FRONTEND no est√° configurado"
            ERROR=1
          else
            echo "‚úÖ PM2_APP_NAME_FRONTEND: ${{ secrets.PM2_APP_NAME_FRONTEND }}"
          fi
          
          echo "=================================================="
          if [ $ERROR -eq 1 ]; then
            echo "‚ùå Validaci√≥n FALLIDA"
            exit 1
          else
            echo "‚úÖ Todos los secretos est√°n configurados correctamente"
          fi

  # ==============================================================================
  # JOB 1: Build y Deploy Backend
  # ==============================================================================
  deploy-backend:
    name: üîß Deploy Backend (.NET)
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì¶ Restore Dependencies
        run: |
          cd BackendMillionApi
          dotnet restore

      - name: üèóÔ∏è Build Backend
        run: |
          cd BackendMillionApi
          dotnet publish -c Release -o ./publish

      - name: üì§ Deploy to Server
        run: |
          echo "Configurando SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          echo "=================================================="
          echo "üì§ Desplegando backend al servidor..."
          echo "=================================================="
          
          # Crear directorio de backup
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.APP_PATH_BACKEND }}/backup"
          
          # Backup de configuraci√≥n actual
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            if [ -f ${{ secrets.APP_PATH_BACKEND }}/appsettings.json ]; then
              cp ${{ secrets.APP_PATH_BACKEND }}/appsettings.json ${{ secrets.APP_PATH_BACKEND }}/backup/
            fi
          "
          
          # Copiar archivos compilados al servidor
          rsync -avz --delete \
            --exclude='appsettings.json' \
            --exclude='appsettings.*.json' \
            BackendMillionApi/publish/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.APP_PATH_BACKEND }}/
          
          # Restaurar configuraci√≥n
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            if [ -f ${{ secrets.APP_PATH_BACKEND }}/backup/appsettings.json ]; then
              cp ${{ secrets.APP_PATH_BACKEND }}/backup/appsettings.json ${{ secrets.APP_PATH_BACKEND }}/
            fi
          "
          
          echo "‚úÖ Archivos desplegados correctamente"

      - name: üîÑ Restart Backend Service
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üîÑ Reiniciando servicio del backend..."
            echo "=================================================="
            
            # Reiniciar con systemd
            if command -v systemctl &> /dev/null; then
              sudo systemctl restart backend-million 2>/dev/null || echo "‚ö†Ô∏è  Servicio systemd no encontrado"
            fi
            
            # O reiniciar con PM2 si usas PM2 para .NET
            if command -v pm2 &> /dev/null; then
              cd ${{ secrets.APP_PATH_BACKEND }}
              pm2 restart backend-million 2>/dev/null || \
                pm2 start BackendMillionApi.dll --name backend-million --interpreter dotnet
            fi
            
            echo "‚úÖ Servicio del backend reiniciado"
          EOF

  # ==============================================================================
  # JOB 2: Build y Deploy Frontend
  # ==============================================================================
  deploy-frontend:
    name: üé® Deploy Frontend (Next.js)
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üé® Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üì¶ Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: üèóÔ∏è Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: üì§ Deploy to Server
        run: |
          echo "Configurando SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          echo "=================================================="
          echo "üì§ Desplegando frontend al servidor..."
          echo "=================================================="
          
          # Copiar archivos al servidor
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='.env.local' \
            --exclude='.env*.local' \
            frontend/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.APP_PATH_FRONTEND }}/
          
          echo "‚úÖ Archivos desplegados correctamente"

      - name: üîÑ Restart Frontend with PM2
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üîÑ Reiniciando aplicaci√≥n frontend con PM2..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_FRONTEND }}
            
            if ! command -v pm2 &> /dev/null; then
              echo "‚ùå Error: PM2 no est√° instalado"
              exit 1
            fi
            
            APP_NAME="${{ secrets.PM2_APP_NAME_FRONTEND }}"
            
            # Reinstalar dependencias en producci√≥n si es necesario
            npm ci --production
            
            # Reiniciar o iniciar la aplicaci√≥n
            if pm2 list | grep -q "$APP_NAME"; then
              echo "üîÑ Reiniciando aplicaci√≥n existente..."
              pm2 restart "$APP_NAME"
            else
              echo "üöÄ Iniciando nueva aplicaci√≥n..."
              pm2 start npm --name "$APP_NAME" -- start
            fi
            
            pm2 save
            pm2 list
            
            echo "‚úÖ Aplicaci√≥n frontend reiniciada correctamente"
          EOF

  # ==============================================================================
  # JOB 3: Notificaci√≥n de √âxito
  # ==============================================================================
  notify-success:
    name: ‚úÖ Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: üéâ Success Notification
        run: |
          echo "=================================================="
          echo "‚úÖ DESPLIEGUE EXITOSO"
          echo "=================================================="
          echo "Backend: Desplegado en ${{ secrets.APP_PATH_BACKEND }}"
          echo "Frontend: Desplegado en ${{ secrets.APP_PATH_FRONTEND }}"
          echo "Commit: ${{ github.sha }}"
          echo "Rama: ${{ github.ref_name }}"
          echo "=================================================="

  # ==============================================================================
  # JOB 4: Notificaci√≥n de Fallo
  # ==============================================================================
  notify-failure:
    name: ‚ùå Deployment Failed
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()
    
    steps:
      - name: ‚ùå Failure Notification
        run: |
          echo "=================================================="
          echo "‚ùå DESPLIEGUE FALLIDO"
          echo "=================================================="
          echo "Revisa los logs para m√°s detalles"
          echo "Commit: ${{ github.sha }}"
          echo "=================================================="
          exit 1

