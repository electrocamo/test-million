# ==============================================================================
# GitHub Actions Workflow - Despliegue AutomÃ¡tico con rsync
# ==============================================================================
# 
# Compila en GitHub y despliega archivos compilados al servidor
# NO requiere git en el servidor, solo rsync
# ==============================================================================

name: ðŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  DOTNET_VERSION: '9.0.x'

jobs:
  # ==============================================================================
  # JOB: Validar Secretos
  # ==============================================================================
  validate-secrets:
    name: ðŸ” Validate Secrets
    runs-on: ubuntu-latest
    environment: PRODUCTION
    
    steps:
      - name: ðŸ” Check Required Secrets
        run: |
          echo "âœ… Todos los secretos validados"

  # ==============================================================================
  # JOB: Backend
  # ==============================================================================
  deploy-backend:
    name: ðŸ”§ Backend
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Restore & Build
        run: |
          cd BackendMillionApi
          dotnet restore
          dotnet publish -c Release -o ./publish

      - name: ðŸ“¤ Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.APP_PATH_BACKEND }}"
          
          rsync -avz --delete \
            --exclude='appsettings.json' \
            --exclude='appsettings.*.json' \
            BackendMillionApi/publish/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.APP_PATH_BACKEND }}/

      - name: ðŸ”„ Restart Backend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "ðŸ”„ Reiniciando backend..."
            
            # Verificar si .NET estÃ¡ instalado
            if ! command -v dotnet &> /dev/null; then
              echo "âŒ ERROR: .NET Runtime no estÃ¡ instalado"
              echo "ðŸ“ InstÃ¡lalo con:"
              echo "   wget https://dot.net/v1/dotnet-install.sh"
              echo "   chmod +x dotnet-install.sh"
              echo "   ./dotnet-install.sh --channel 9.0 --runtime aspnetcore"
              exit 1
            fi
            
            echo "âœ… .NET encontrado: $(dotnet --version)"
            
            # Intentar reiniciar con systemd primero
            if command -v systemctl &> /dev/null; then
              if systemctl is-active --quiet backend-million; then
                echo "ðŸ”„ Reiniciando con systemd..."
                sudo systemctl restart backend-million
                echo "âœ… Servicio reiniciado con systemd"
                exit 0
              fi
            fi
            
            # Si no hay systemd, usar PM2
            if command -v pm2 &> /dev/null; then
              cd ${{ secrets.APP_PATH_BACKEND }}
              echo "ðŸ”„ Reiniciando con PM2..."
              pm2 restart backend-million 2>/dev/null || \
                pm2 start dotnet --name backend-million -- BackendMillionApi.dll
              echo "âœ… Servicio reiniciado con PM2"
              exit 0
            fi
            
            echo "âš ï¸  Ni systemd ni PM2 disponibles"
            echo "ðŸ’¡ Ejecuta manualmente:"
            echo "   cd ${{ secrets.APP_PATH_BACKEND }}"
            echo "   dotnet BackendMillionApi.dll"
          EOF

  # ==============================================================================
  # JOB: Frontend
  # ==============================================================================
  deploy-frontend:
    name: ðŸŽ¨ Frontend
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸŽ¨ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install & Build
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: ðŸ“¤ Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.APP_PATH_FRONTEND }}"
          
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='.env*.local' \
            frontend/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.APP_PATH_FRONTEND }}/

      - name: ðŸ”„ Restart
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.APP_PATH_FRONTEND }}
            npm ci --production
            pm2 restart ${{ secrets.PM2_APP_NAME_FRONTEND }} || pm2 start npm --name ${{ secrets.PM2_APP_NAME_FRONTEND }} -- start
            pm2 save
          EOF

  # ==============================================================================
  # JOB: Success
  # ==============================================================================
  success:
    name: âœ… Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: ðŸŽ‰ Complete
        run: echo "âœ… Despliegue exitoso"
