# ==============================================================================
# GitHub Actions Workflow - Despliegue Autom√°tico a Producci√≥n
# ==============================================================================
# 
# Este workflow se ejecuta autom√°ticamente cuando se hace push a la rama main
# y despliega tanto el backend (.NET) como el frontend (Next.js) al servidor
#
# Secretos requeridos en el repositorio:
# - SSH_HOST: Direcci√≥n IP o dominio del servidor
# - SSH_USER: Usuario SSH para conectarse al servidor
# - SSH_KEY: Clave privada SSH para autenticaci√≥n
# - APP_PATH_BACKEND: Ruta del proyecto backend en el servidor
# - APP_PATH_FRONTEND: Ruta del proyecto frontend en el servidor
# - PM2_APP_NAME_FRONTEND: Nombre de la aplicaci√≥n frontend en PM2
# ==============================================================================

name: üöÄ Deploy to Production

# Trigger: Se ejecuta cuando hay push a la rama main
on:
  push:
    branches:
      - main

# Configuraci√≥n de variables de entorno globales
env:
  NODE_VERSION: '18.x'
  DOTNET_VERSION: '9.0.x'

jobs:
  # ==============================================================================
  # JOB 1: Despliegue del Backend (.NET)
  # ==============================================================================
  deploy-backend:
    name: üîß Deploy Backend (.NET)
    runs-on: ubuntu-latest
    
    steps:
      # ------------------------------------------------------------------------------
      # Paso 1: Configurar clave SSH para conexi√≥n al servidor
      # ------------------------------------------------------------------------------
      - name: üîê Configure SSH Key
        run: |
          echo "Configurando clave SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ Clave SSH configurada correctamente"

      # ------------------------------------------------------------------------------
      # Paso 2: Conectar al servidor y actualizar el c√≥digo del backend
      # ------------------------------------------------------------------------------
      - name: üì• Pull Latest Code (Backend)
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üîÑ Actualizando c√≥digo del backend..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_BACKEND }}
            
            # Verificar si el directorio existe
            if [ ! -d ".git" ]; then
              echo "‚ùå Error: No es un repositorio git v√°lido"
              exit 1
            fi
            
            # Guardar cambios locales si existen
            git stash
            
            # Actualizar c√≥digo desde el repositorio
            git pull origin main
            
            # Aplicar stash si hab√≠a cambios
            git stash pop || true
            
            echo "‚úÖ C√≥digo actualizado correctamente"
          EOF

      # ------------------------------------------------------------------------------
      # Paso 3: Restaurar dependencias de .NET
      # ------------------------------------------------------------------------------
      - name: üì¶ Restore Dependencies (Backend)
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üì¶ Instalando dependencias del backend..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_BACKEND }}/BackendMillionApi
            
            # Verificar si dotnet est√° instalado
            if ! command -v dotnet &> /dev/null; then
              echo "‚ùå Error: .NET no est√° instalado en el servidor"
              exit 1
            fi
            
            # Restaurar dependencias
            dotnet restore
            
            echo "‚úÖ Dependencias restauradas correctamente"
          EOF

      # ------------------------------------------------------------------------------
      # Paso 4: Compilar y publicar el backend
      # ------------------------------------------------------------------------------
      - name: üèóÔ∏è Build Backend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üèóÔ∏è  Compilando backend..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_BACKEND }}/BackendMillionApi
            
            # Compilar en modo Release
            dotnet publish -c Release -o ./publish
            
            echo "‚úÖ Backend compilado correctamente"
          EOF

      # ------------------------------------------------------------------------------
      # Paso 5: Reiniciar el servicio del backend
      # ------------------------------------------------------------------------------
      - name: üîÑ Restart Backend Service
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üîÑ Reiniciando servicio del backend..."
            echo "=================================================="
            
            # Verificar si systemd est√° disponible
            if command -v systemctl &> /dev/null; then
              # Reiniciar usando systemd (ajustar nombre del servicio)
              sudo systemctl restart backend-million || echo "‚ö†Ô∏è  Servicio systemd no encontrado"
            fi
            
            # Alternativamente, si usas PM2 para .NET
            if command -v pm2 &> /dev/null; then
              cd ${{ secrets.APP_PATH_BACKEND }}/BackendMillionApi/publish
              pm2 restart backend-million || pm2 start BackendMillionApi.dll --name backend-million --interpreter dotnet
            fi
            
            echo "‚úÖ Servicio del backend reiniciado"
          EOF

  # ==============================================================================
  # JOB 2: Despliegue del Frontend (Next.js)
  # ==============================================================================
  deploy-frontend:
    name: üé® Deploy Frontend (Next.js)
    runs-on: ubuntu-latest
    
    steps:
      # ------------------------------------------------------------------------------
      # Paso 1: Configurar clave SSH para conexi√≥n al servidor
      # ------------------------------------------------------------------------------
      - name: üîê Configure SSH Key
        run: |
          echo "Configurando clave SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ Clave SSH configurada correctamente"

      # ------------------------------------------------------------------------------
      # Paso 2: Conectar al servidor y actualizar el c√≥digo del frontend
      # ------------------------------------------------------------------------------
      - name: üì• Pull Latest Code (Frontend)
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üîÑ Actualizando c√≥digo del frontend..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_FRONTEND }}
            
            # Verificar si el directorio existe
            if [ ! -d ".git" ]; then
              echo "‚ùå Error: No es un repositorio git v√°lido"
              exit 1
            fi
            
            # Guardar cambios locales si existen
            git stash
            
            # Actualizar c√≥digo desde el repositorio
            git pull origin main
            
            # Aplicar stash si hab√≠a cambios
            git stash pop || true
            
            echo "‚úÖ C√≥digo actualizado correctamente"
          EOF

      # ------------------------------------------------------------------------------
      # Paso 3: Instalar dependencias de Node.js
      # ------------------------------------------------------------------------------
      - name: üì¶ Install Dependencies (Frontend)
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üì¶ Instalando dependencias del frontend..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_FRONTEND }}/frontend
            
            # Verificar si Node.js est√° instalado
            if ! command -v node &> /dev/null; then
              echo "‚ùå Error: Node.js no est√° instalado en el servidor"
              exit 1
            fi
            
            # Verificar versi√≥n de Node
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            
            # Instalar dependencias (production only)
            npm ci --production=false
            
            echo "‚úÖ Dependencias instaladas correctamente"
          EOF

      # ------------------------------------------------------------------------------
      # Paso 4: Compilar el frontend
      # ------------------------------------------------------------------------------
      - name: üèóÔ∏è Build Frontend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üèóÔ∏è  Compilando frontend..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_FRONTEND }}/frontend
            
            # Compilar aplicaci√≥n Next.js
            npm run build
            
            # Verificar que el build fue exitoso
            if [ ! -d ".next" ]; then
              echo "‚ùå Error: El build fall√≥, directorio .next no existe"
              exit 1
            fi
            
            echo "‚úÖ Frontend compilado correctamente"
          EOF

      # ------------------------------------------------------------------------------
      # Paso 5: Reiniciar la aplicaci√≥n frontend con PM2
      # ------------------------------------------------------------------------------
      - name: üîÑ Restart Frontend with PM2
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "=================================================="
            echo "üîÑ Reiniciando aplicaci√≥n frontend con PM2..."
            echo "=================================================="
            cd ${{ secrets.APP_PATH_FRONTEND }}/frontend
            
            # Verificar si PM2 est√° instalado
            if ! command -v pm2 &> /dev/null; then
              echo "‚ùå Error: PM2 no est√° instalado"
              echo "üí° Instalar con: npm install -g pm2"
              exit 1
            fi
            
            # Nombre de la aplicaci√≥n en PM2
            APP_NAME="${{ secrets.PM2_APP_NAME_FRONTEND }}"
            
            # Verificar si la aplicaci√≥n ya est√° corriendo en PM2
            if pm2 list | grep -q "$APP_NAME"; then
              echo "üîÑ Reiniciando aplicaci√≥n existente..."
              pm2 restart "$APP_NAME"
            else
              echo "üöÄ Iniciando nueva aplicaci√≥n..."
              pm2 start npm --name "$APP_NAME" -- start
            fi
            
            # Guardar configuraci√≥n de PM2
            pm2 save
            
            # Mostrar estado de PM2
            pm2 list
            
            echo "‚úÖ Aplicaci√≥n frontend reiniciada correctamente"
          EOF

  # ==============================================================================
  # JOB 3: Ejecutar Tests (Opcional - descomenta si quieres tests antes del deploy)
  # ==============================================================================
  # run-tests:
  #   name: üß™ Run Tests
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: üì• Checkout Code
  #       uses: actions/checkout@v4
  #     
  #     # Tests del Backend
  #     - name: üîß Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: ${{ env.DOTNET_VERSION }}
  #     
  #     - name: üß™ Run Backend Tests
  #       run: |
  #         cd BackendMillion.Test
  #         dotnet test --verbosity normal
  #     
  #     # Tests del Frontend
  #     - name: üé® Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #     
  #     - name: üì¶ Install Frontend Dependencies
  #       run: |
  #         cd frontend
  #         npm ci
  #     
  #     - name: üß™ Run Frontend Tests
  #       run: |
  #         cd frontend
  #         npm test

  # ==============================================================================
  # JOB 4: Notificaci√≥n de Despliegue Exitoso
  # ==============================================================================
  notify-success:
    name: ‚úÖ Notify Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: üéâ Deployment Success
        run: |
          echo "=================================================="
          echo "‚úÖ DESPLIEGUE EXITOSO"
          echo "=================================================="
          echo "Backend: Desplegado correctamente"
          echo "Frontend: Desplegado correctamente"
          echo "Fecha: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "=================================================="

  # ==============================================================================
  # JOB 5: Notificaci√≥n de Fallo en el Despliegue
  # ==============================================================================
  notify-failure:
    name: ‚ùå Notify Failure
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()
    
    steps:
      - name: ‚ùå Deployment Failed
        run: |
          echo "=================================================="
          echo "‚ùå DESPLIEGUE FALLIDO"
          echo "=================================================="
          echo "Revisa los logs para m√°s detalles"
          echo "Commit: ${{ github.sha }}"
          echo "=================================================="
          exit 1

