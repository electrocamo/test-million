# ==============================================================================
# GitHub Actions Workflow - Despliegue Autom√°tico con rsync
# ==============================================================================
# 
# Compila en GitHub y despliega archivos compilados al servidor
# NO requiere git en el servidor, solo rsync
# ==============================================================================

name: üöÄ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  DOTNET_VERSION: '9.0.x'

jobs:
  # ==============================================================================
  # JOB: Validar Secretos
  # ==============================================================================
  validate-secrets:
    name: üîç Validate Secrets
    runs-on: ubuntu-latest
    environment: PRODUCTION
    
    steps:
      - name: üîç Check Required Secrets
        run: |
          echo "‚úÖ Todos los secretos validados"

  # ==============================================================================
  # JOB: Backend
  # ==============================================================================
  deploy-backend:
    name: üîß Backend
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì¶ Restore & Build
        run: |
          cd BackendMillionApi
          dotnet restore
          dotnet publish -c Release -o ./publish

      - name: üì§ Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.APP_PATH_BACKEND }}"
          
          rsync -avz --delete \
            --exclude='appsettings.json' \
            --exclude='appsettings.*.json' \
            BackendMillionApi/publish/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.APP_PATH_BACKEND }}/

      - name: üîÑ Setup & Restart Backend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "üîÑ Configurando backend..."
            
            # Verificar si .NET est√° instalado
            if ! command -v dotnet &> /dev/null; then
              echo "‚öôÔ∏è  .NET no encontrado, instalando autom√°ticamente..."
              
              # Instalar .NET Runtime
              wget -q https://dot.net/v1/dotnet-install.sh -O /tmp/dotnet-install.sh
              chmod +x /tmp/dotnet-install.sh
              /tmp/dotnet-install.sh --channel 9.0 --runtime aspnetcore --install-dir $HOME/.dotnet
              
              # Agregar al PATH
              if ! grep -q 'export PATH="$PATH:$HOME/.dotnet"' ~/.bashrc; then
                echo 'export DOTNET_ROOT=$HOME/.dotnet' >> ~/.bashrc
                echo 'export PATH="$PATH:$HOME/.dotnet"' >> ~/.bashrc
              fi
              
              # Aplicar cambios
              export DOTNET_ROOT=$HOME/.dotnet
              export PATH="$PATH:$HOME/.dotnet"
              
              # Limpiar
              rm -f /tmp/dotnet-install.sh
              
              echo "‚úÖ .NET Runtime instalado: $($HOME/.dotnet/dotnet --version)"
            else
              echo "‚úÖ .NET encontrado: $(dotnet --version)"
            fi
            
            # Asegurar que dotnet est√© en el PATH
            export DOTNET_ROOT=$HOME/.dotnet
            export PATH="$PATH:$HOME/.dotnet"
            
            # Intentar reiniciar con systemd primero
            if command -v systemctl &> /dev/null; then
              if systemctl is-active --quiet backend-million; then
                echo "üîÑ Reiniciando con systemd..."
                sudo systemctl restart backend-million
                echo "‚úÖ Servicio reiniciado con systemd"
                exit 0
              fi
            fi
            
            # Si no hay systemd, usar PM2
            if command -v pm2 &> /dev/null; then
              cd ${{ secrets.APP_PATH_BACKEND }}
              echo "üîÑ Reiniciando con PM2..."
              pm2 restart backend-million 2>/dev/null || \
                pm2 start dotnet --name backend-million -- BackendMillionApi.dll
              echo "‚úÖ Servicio reiniciado con PM2"
              exit 0
            fi
            
            echo "‚ö†Ô∏è  Ni systemd ni PM2 disponibles"
            echo "üí° Ejecuta manualmente:"
            echo "   cd ${{ secrets.APP_PATH_BACKEND }}"
            echo "   dotnet BackendMillionApi.dll"
          EOF

  # ==============================================================================
  # JOB: Frontend
  # ==============================================================================
  deploy-frontend:
    name: üé® Frontend
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üé® Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Install & Build
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: üì§ Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.APP_PATH_FRONTEND }}"
          
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='.env*.local' \
            frontend/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.APP_PATH_FRONTEND }}/

      - name: üîÑ Restart Frontend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "üîÑ Reiniciando frontend..."
            cd ${{ secrets.APP_PATH_FRONTEND }}
            
            # Instalar dependencias de producci√≥n
            echo "üì¶ Instalando dependencias..."
            npm ci --production
            
            # Verificar si PM2 est√° instalado
            if ! command -v pm2 &> /dev/null; then
              echo "‚ùå ERROR: PM2 no est√° instalado"
              echo "üìù Inst√°lalo con: sudo npm install -g pm2"
              exit 1
            fi
            
            APP_NAME="${{ secrets.PM2_APP_NAME_FRONTEND }}"
            FRONTEND_PORT="${{ secrets.FRONTEND_PORT }}"
            
            # Puerto por defecto si no est√° configurado
            if [ -z "$FRONTEND_PORT" ]; then
              FRONTEND_PORT=3000
              echo "‚ö†Ô∏è  FRONTEND_PORT no configurado, usando puerto por defecto: 3000"
            else
              echo "‚úÖ Puerto configurado: $FRONTEND_PORT"
            fi
            
            # Verificar si la app ya existe en PM2
            if pm2 list | grep -q "$APP_NAME"; then
              echo "üîÑ Aplicaci√≥n existe, reiniciando..."
              # Actualizar variables de entorno y reiniciar
              pm2 delete "$APP_NAME"
              echo "‚úÖ Aplicaci√≥n anterior eliminada"
            fi
            
            # Limpiar puerto antes de iniciar
            echo "üßπ Limpiando puerto $FRONTEND_PORT..."
            lsof -ti:$FRONTEND_PORT | xargs kill -9 2>/dev/null || true
            
            # Iniciar aplicaci√≥n con puerto personalizado
            echo "üöÄ Iniciando aplicaci√≥n en puerto $FRONTEND_PORT..."
            PORT=$FRONTEND_PORT pm2 start npm --name "$APP_NAME" -- start
            
            # Guardar configuraci√≥n de PM2
            pm2 save
            
            # Mostrar estado
            pm2 list
            
            echo "=================================================="
            echo "‚úÖ Frontend desplegado correctamente"
            echo "üåê Accesible en: http://$(hostname -I | awk '{print $1}'):$FRONTEND_PORT"
            echo "=================================================="
          EOF

  # ==============================================================================
  # JOB: Success
  # ==============================================================================
  success:
    name: ‚úÖ Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: üéâ Complete
        run: echo "‚úÖ Despliegue exitoso"
