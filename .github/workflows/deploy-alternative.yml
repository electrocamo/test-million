# ==============================================================================
# Workflow Alternativo - Para Estructura de Directorios Personalizada
# ==============================================================================
# 
# Este workflow est√° dise√±ado para:
# - Backend en: /var/www/TestMillion/Back (sin .git)
# - Frontend en: /var/www/TestMillion/Front (sin .git)
# - Actualiza desde un repositorio temporal
# ==============================================================================

name: üöÄ Deploy to Production (Alternative)

on:
  push:
    branches:
      - main

env:
  NODE_VERSION: '18.x'
  DOTNET_VERSION: '9.0.x'
  TEMP_REPO_PATH: '/tmp/TestMillion_deploy'

jobs:
  # ==============================================================================
  # JOB 0: Validar Secretos
  # ==============================================================================
  validate-secrets:
    name: üîç Validate Secrets
    runs-on: ubuntu-latest
    environment: PRODUCTION
    
    steps:
      - name: üîç Check Required Secrets
        run: |
          echo "üîç Validando secretos..."
          
          ERROR=0
          
          [ -z "${{ secrets.SSH_HOST }}" ] && echo "‚ùå SSH_HOST vac√≠o" && ERROR=1 || echo "‚úÖ SSH_HOST OK"
          [ -z "${{ secrets.SSH_USER }}" ] && echo "‚ùå SSH_USER vac√≠o" && ERROR=1 || echo "‚úÖ SSH_USER OK"
          [ -z "${{ secrets.SSH_KEY }}" ] && echo "‚ùå SSH_KEY vac√≠o" && ERROR=1 || echo "‚úÖ SSH_KEY OK"
          [ -z "${{ secrets.APP_PATH_BACKEND }}" ] && echo "‚ùå APP_PATH_BACKEND vac√≠o" && ERROR=1 || echo "‚úÖ APP_PATH_BACKEND: ${{ secrets.APP_PATH_BACKEND }}"
          [ -z "${{ secrets.APP_PATH_FRONTEND }}" ] && echo "‚ùå APP_PATH_FRONTEND vac√≠o" && ERROR=1 || echo "‚úÖ APP_PATH_FRONTEND: ${{ secrets.APP_PATH_FRONTEND }}"
          [ -z "${{ secrets.PM2_APP_NAME_FRONTEND }}" ] && echo "‚ùå PM2_APP_NAME_FRONTEND vac√≠o" && ERROR=1 || echo "‚úÖ PM2_APP_NAME_FRONTEND OK"
          
          [ $ERROR -eq 1 ] && exit 1 || echo "‚úÖ Todos los secretos OK"

  # ==============================================================================
  # JOB 1: Despliegue del Backend
  # ==============================================================================
  deploy-backend:
    name: üîß Deploy Backend
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: üîê Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: üì• Update Code and Deploy Backend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
            
            echo "=================================================="
            echo "üîÑ Actualizando Backend..."
            echo "=================================================="
            
            # Limpiar y recrear directorio temporal
            rm -rf ${{ env.TEMP_REPO_PATH }}
            mkdir -p ${{ env.TEMP_REPO_PATH }}
            
            # Clonar repositorio en temporal
            echo "üì• Clonando repositorio..."
            git clone --depth 1 --branch main https://github.com/${{ github.repository }}.git ${{ env.TEMP_REPO_PATH }}
            
            # Verificar que BackendMillionApi existe
            if [ ! -d "${{ env.TEMP_REPO_PATH }}/BackendMillionApi" ]; then
              echo "‚ùå Error: No se encontr√≥ BackendMillionApi en el repositorio"
              exit 1
            fi
            
            # Crear directorio de destino si no existe
            mkdir -p ${{ secrets.APP_PATH_BACKEND }}
            
            # Sincronizar archivos (preservar archivos de configuraci√≥n)
            echo "üîÑ Sincronizando archivos..."
            rsync -av --delete \
              --exclude='.git' \
              --exclude='bin/' \
              --exclude='obj/' \
              --exclude='publish/' \
              --exclude='appsettings.Production.json' \
              ${{ env.TEMP_REPO_PATH }}/BackendMillionApi/ \
              ${{ secrets.APP_PATH_BACKEND }}/
            
            # Compilar
            echo "üèóÔ∏è  Compilando backend..."
            cd ${{ secrets.APP_PATH_BACKEND }}
            
            if ! command -v dotnet &> /dev/null; then
              echo "‚ùå .NET no est√° instalado"
              exit 1
            fi
            
            dotnet restore
            dotnet publish -c Release -o ./publish
            
            # Reiniciar servicio
            echo "üîÑ Reiniciando servicio..."
            if command -v systemctl &> /dev/null; then
              sudo systemctl restart backend-million 2>/dev/null || echo "‚ö†Ô∏è  Servicio systemd no encontrado"
            fi
            
            if command -v pm2 &> /dev/null; then
              cd publish
              pm2 restart backend-million 2>/dev/null || pm2 start BackendMillionApi.dll --name backend-million --interpreter dotnet
            fi
            
            # Limpiar temporal
            rm -rf ${{ env.TEMP_REPO_PATH }}
            
            echo "‚úÖ Backend desplegado correctamente"
          ENDSSH

  # ==============================================================================
  # JOB 2: Despliegue del Frontend
  # ==============================================================================
  deploy-frontend:
    name: üé® Deploy Frontend
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment: PRODUCTION
    
    steps:
      - name: üîê Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: üì• Update Code and Deploy Frontend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
            
            echo "=================================================="
            echo "üîÑ Actualizando Frontend..."
            echo "=================================================="
            
            # Limpiar y recrear directorio temporal
            rm -rf ${{ env.TEMP_REPO_PATH }}
            mkdir -p ${{ env.TEMP_REPO_PATH }}
            
            # Clonar repositorio en temporal
            echo "üì• Clonando repositorio..."
            git clone --depth 1 --branch main https://github.com/${{ github.repository }}.git ${{ env.TEMP_REPO_PATH }}
            
            # Verificar que frontend existe
            if [ ! -d "${{ env.TEMP_REPO_PATH }}/frontend" ]; then
              echo "‚ùå Error: No se encontr√≥ frontend en el repositorio"
              exit 1
            fi
            
            # Crear directorio de destino si no existe
            mkdir -p ${{ secrets.APP_PATH_FRONTEND }}
            
            # Sincronizar archivos (preservar node_modules y .env)
            echo "üîÑ Sincronizando archivos..."
            rsync -av --delete \
              --exclude='.git' \
              --exclude='node_modules/' \
              --exclude='.next/' \
              --exclude='.env.local' \
              --exclude='.env.production' \
              ${{ env.TEMP_REPO_PATH }}/frontend/ \
              ${{ secrets.APP_PATH_FRONTEND }}/
            
            # Compilar
            echo "üèóÔ∏è  Compilando frontend..."
            cd ${{ secrets.APP_PATH_FRONTEND }}
            
            if ! command -v node &> /dev/null; then
              echo "‚ùå Node.js no est√° instalado"
              exit 1
            fi
            
            echo "Node: $(node --version)"
            echo "NPM: $(npm --version)"
            
            npm ci --production=false
            npm run build
            
            # Verificar build
            if [ ! -d ".next" ]; then
              echo "‚ùå Build fall√≥"
              exit 1
            fi
            
            # Reiniciar con PM2
            echo "üîÑ Reiniciando con PM2..."
            if ! command -v pm2 &> /dev/null; then
              echo "‚ùå PM2 no est√° instalado"
              exit 1
            fi
            
            APP_NAME="${{ secrets.PM2_APP_NAME_FRONTEND }}"
            
            if pm2 list | grep -q "$APP_NAME"; then
              pm2 restart "$APP_NAME"
            else
              pm2 start npm --name "$APP_NAME" -- start
            fi
            
            pm2 save
            pm2 list
            
            # Limpiar temporal
            rm -rf ${{ env.TEMP_REPO_PATH }}
            
            echo "‚úÖ Frontend desplegado correctamente"
          ENDSSH

  # ==============================================================================
  # JOB 3: Notificaci√≥n de √âxito
  # ==============================================================================
  notify-success:
    name: ‚úÖ Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: üéâ Deployment Success
        run: |
          echo "=================================================="
          echo "‚úÖ DESPLIEGUE EXITOSO"
          echo "=================================================="
          echo "Backend: ‚úÖ Desplegado"
          echo "Frontend: ‚úÖ Desplegado"
          echo "Commit: ${{ github.sha }}"
          echo "=================================================="

  # ==============================================================================
  # JOB 4: Notificaci√≥n de Fallo
  # ==============================================================================
  notify-failure:
    name: ‚ùå Failure
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()
    
    steps:
      - name: ‚ùå Deployment Failed
        run: |
          echo "=================================================="
          echo "‚ùå DESPLIEGUE FALLIDO"
          echo "=================================================="
          echo "Revisa los logs en GitHub Actions"
          echo "=================================================="
          exit 1

